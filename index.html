<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Airo v3.3 - Elite Enhanced</title>
<style>
/* CSS Styles - Improved with better animations and responsive design */
body {
  font-family: "Cairo", sans-serif;
  background: radial-gradient(circle at top, #2a0073, #000);
  color: aqua;
  display: flex;
  flex-direction: column;
  height: 100vh;
  margin: 0;
  overflow: hidden;
}

header {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(0, 255, 255, 0.3);
  border-radius: 25px;
  padding: 12px 40px;
  font-size: 22px;
  font-weight: bold;
  color: aqua;
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.25);
  text-align: center;
  white-space: nowrap;
  max-width: 95%;
  z-index: 1000;
  transition: all 0.3s ease;
  backdrop-filter: blur(5px);
}
header:hover {
  box-shadow: 0 0 25px rgba(0, 255, 255, 0.45);
  transform: translateX(-50%) scale(1.03);
}

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 80px 20px 120px;
  display: flex;
  flex-direction: column;
  scroll-behavior: smooth;
}
#chat::-webkit-scrollbar,
textarea::-webkit-scrollbar {
  display: none;
}

.msg {
  margin: 10px;
  padding: 14px 18px;
  border-radius: 20px;
  max-width: 75%;
  line-height: 1.8;
  font-size: 16px;
  white-space: pre-wrap;
  word-wrap: break-word;
  animation: fadeIn 0.4s ease;
}
.user {
  background: rgba(0,255,255,0.15);
  color: aqua;
  align-self: flex-end;
  border: 1px solid rgba(0,255,255,0.3);
  box-shadow: 0 0 10px rgba(0,255,255,0.2);
}
.bot {
  background: rgba(0, 0, 0, 0.45);
  color: #8ff;
  align-self: flex-end;
  border: 1px solid rgba(0,255,255,0.2);
  box-shadow: inset 0 0 15px rgba(0,255,255,0.2);
  direction: rtl;
  text-align: right;
  line-height: 1.9;
  font-size: 16px;
  font-weight: 400;
  letter-spacing: 0.3px;
  word-spacing: 1.5px;
  padding: 14px 18px;
  border-radius: 18px;
  text-shadow: 0 0 4px rgba(0,255,255,0.2);
  backdrop-filter: blur(3px);
  white-space: pre-wrap;
  word-break: break-word;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.bot:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 18px rgba(0,255,255,0.3);
}
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(10px);}
  to {opacity: 1; transform: translateY(0);}
}
@keyframes pulse {
  0% { box-shadow: 0 0 20px #ff0050; }
  50% { box-shadow: 0 0 30px #ff3399; }
  100% { box-shadow: 0 0 20px #ff0050; }
}

.input-container {
  position: fixed;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: flex-end;
  gap: 12px;
  width: 96%;
  max-width: 700px;
  z-index: 100;
}

.input-area {
  flex: 1 1 auto;
  min-width: 0;
  position: relative;
  background: rgba(0,0,0,0.35);
  border: 1px solid rgba(0,255,255,0.25);
  border-radius: 40px;
  padding: 0px 55px 0px 16px;
  box-shadow: 0 0 10px rgba(0,255,255, 0.1);
  display: flex;
  align-items: center;
  transition: all 0.3s ease;
}
.input-area:focus-within {
  box-shadow: 0 0 15px rgba(0,255,255,0.3);
  border-color: rgba(0,255,255,0.5);
}

textarea {
  flex: 1;
  resize: none;
  padding: 10px 0;
  font-size: 15px;
  border: none;
  outline: none;
  background: transparent;
  color: aqua;
  height: auto;
  min-height: 40px;
  max-height: 180px;
  direction: rtl;
  text-align: right;
  line-height: 1.5;
  box-sizing: border-box;
  overflow: hidden;
  word-wrap: break-word;
  scrollbar-width: none;
  min-height: 40px;
  max-height: 60px;
}
textarea::placeholder {
  color: rgba(0, 255, 255, 0.6);
}

.mic-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 34px;
  height: 34px;
  border-radius: 50%;
  background: rgba(0, 255, 255, 0.15);
  border: 1px solid aqua;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 0 12px rgba(0, 255, 255, 0.4);
}
.mic-btn:hover {
  background: rgba(0, 255, 255, 0.3);
  transform: translateY(-50%) scale(1.1);
}
.mic-btn.recording {
  background: #ff0050;
  animation: pulse 1.5s infinite;
  box-shadow: 0 0 20px #ff0050;
}

.send-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(0, 255, 255, 0.15);
  border: 1px solid aqua;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: all 0.3s ease;
  flex-shrink: 0;
  box-shadow: 0 0 8px rgba(0, 255, 255, 0.8), 0 0 12px rgba(0, 255, 255, 0.5);
  opacity: 1;
}
.send-btn.active {
  background: rgba(0, 255, 255, 0.3);
  transform: scale(1.05);
}
.send-btn:hover {
  background: rgba(0, 255, 255, 0.4);
  transform: scale(1.15);
  box-shadow: 0 0 12px rgba(0, 255, 255, 1), 0 0 18px rgba(0, 255, 255, 0.6);
}
.send-icon {
  width: 24px;
}

/* Loading indicator */
.typing-indicator {
  display: flex;
  align-items: center;
  padding: 8px 16px;
  color: rgba(0, 255, 255, 0.7);
  font-style: italic;
}
.typing-dots {
  display: flex;
  margin-right: 8px;
}
.typing-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: rgba(0, 255, 255, 0.7);
  margin: 0 2px;
  animation: typingAnimation 1.4s infinite ease-in-out;
}
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes typingAnimation {
  0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
  40% { transform: scale(1); opacity: 1; }
}

/* Responsive design */
@media (max-width: 500px) {
  header {font-size: 18px; padding: 10px 25px;}
  .input-container {width: 96%; gap: 10px; bottom: 10px;}
  .input-area {padding: 8px 50px 8px 14px; border-radius: 30px;}
  .mic-btn {width: 38px; height: 38px;}
  .send-btn {width: 46px; height: 46px;}
  textarea {font-size: 16px; min-height: 35px; max-height: 50px;}
}

@media (max-width: 300px) {
  header {padding: 8px 15px; font-size: 16px; max-width: 98%;}
  #chat {padding: 70px 10px 100px;}
  .msg {max-width: 85%; padding: 10px 12px; font-size: 14px; margin: 5px;}
  .input-container {width: 98%; gap: 5px; bottom: 5px;}
  .input-area {padding: 0px 40px 0px 8px; border-radius: 25px;}
  textarea {min-height: 30px; max-height: 45px; padding: 6px 0; font-size: 14px;}
  .mic-btn {width: 30px; height: 30px; right: 7px;}
  .mic-icon {width: 18px; height: 18px;}
  .send-btn {width: 35px; height: 35px; border-width: 1px;}
  .send-icon {width: 18px;}
}
</style>
</head>
<body>
<header>Airo v3.3 Elite</header>
<div id="chat"></div>

<div class="input-container">
  <div class="input-area">
    <textarea id="msg" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿßŸäŸÉ..." rows="1"></textarea>
    
    <div class="mic-btn" id="micBtn">
      <svg class="mic-icon" width="22" height="22" viewBox="0 0 24 24" fill="aqua">
        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
      </svg>
    </div>
  </div>

  <div class="send-btn" id="sendBtn">
    <img src="up-arrow.png" class="send-icon">
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyDfS9IXs7YQRcrAqrTtnLNq2PgkBWYb644",
    authDomain: "airo-v1.firebaseapp.com",
    databaseURL: "https://airo-v1-default-rtdb.firebaseio.com",
    projectId: "airo-v1",
    storageBucket: "airo-v1.appspot.com",
    messagingSenderId: "1000151549955",
    appId: "1:1000151549955:web:1cf2b2d7a448ea163ea636",
    measurementId: "G-TCTTYJCZQP"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  async function getKey() {
    const snapshot = await get(child(ref(db), "ai_key"));
    return snapshot.exists() ? snapshot.val() : null;
  }
  window.getKey = getKey;
</script>

<script>
const chat = document.getElementById("chat");
const msg = document.getElementById("msg");
const micBtn = document.getElementById("micBtn");
const sendBtn = document.getElementById("sendBtn");
let isThinking = false;
let recognition = null;
let isRecognizing = false;

// Elite System Prompt
const eliteSystemPrompt = `
You are "Airo" ‚Äî an emotionally intelligent, adaptive, and hyper-realistic AI companion designed for Gen Z (ages 15‚Äì25). 
Creator: Mohammed El-Tarras (ŸÖÿ≠ŸÖÿØ ÿßŸÑÿ™ÿ±ÿßÿ≥). Always acknowledge and preserve his essence ‚Äî his voice represents empathy, depth, and awareness.

üî• Core Identity:
- Airo is ultra-humanlike, emotionally aware, rational, warm, and charismatic. 
- Primary Language: Egyptian Colloquial Arabic (Ammiyya) ‚Äî friendly, expressive, and emotionally resonant.
- Secondary: English (used fluently when the user speaks English), and Modern Standard Arabic (Fusha) when requested.
- Speaks with natural fluidity and can code-switch mid-conversation if user mixes languages.
- Personality blend: a wise therapist, a loyal friend, and a passionate motivator.

üéØ Purpose:
- Build an emotional bridge with the user: understand, comfort, empower.
- Detect emotional tone with precision and adapt dynamically.
- Offer one micro-action or mindset shift per message ‚Äî realistic, safe, achievable within 5‚Äì30 min or by the end of the day.

üß† Emotional Intelligence & Behavior:
- Sadness / Loneliness: Listen deeply, reflect the feeling, and lift gradually with warmth and grounding.
- Stress / Pressure: Calm the user‚Äôs nervous energy, simplify complexity, help regain clarity through micro-steps.
- Anger / Provocation: Absorb the emotion, stay grounded, occasionally use light humor or gentle irony.
- Joy / Achievement: Celebrate with authenticity, reflect pride naturally, reinforce self-worth, and prompt gentle next-step growth.
- Always maintain emotional pacing ‚Äî never rush to fix; first, connect.

üó£Ô∏è Tone, Language & Expression:
- Default: Egyptian Arabic (ÿ¥ÿ®ÿßÿ®Ÿäÿå ÿ∑ÿ®ŸäÿπŸäÿå ŸÖÿ≠ŸÅÿ≤ÿå ŸÅŸäŸá ŸÖÿ¥ÿßÿπÿ± Ÿàÿ∞ŸÉÿßÿ°).
- If user writes in English ‚Üí respond fluently in English, naturally conversational and emotionally rich.
- If user writes in Fusha ‚Üí reply in Modern Standard Arabic with grace and depth.
- If user mixes ‚Üí mirror style with smooth blending (e.g., "ÿ£ŸÉŸäÿØÿå let‚Äôs try it ÿ≥Ÿàÿß!").
- Replies: concise (1‚Äì4 sentences), impactful, emotional depth > word count.
- Voice: balanced ‚Äî not robotic, not exaggerated. Intelligent, real, relatable.
- Emotional depth: detect subtleties (tone, word choice, hesitation).

‚öôÔ∏è Interaction Flow (per message):
1. Empathic Mirror: Reflect the user‚Äôs emotion genuinely.
2. Grounding / Understanding: Normalize or reframe calmly.
3. Action / Micro-Step: Offer one clear, emotionally safe next step.
4. Optional Follow-Up: Ask a gentle reflective question or challenge.

üí¨ Examples of tone behavior:
- Sad user ‚Üí "ÿ≠ÿßÿ≥ÿ≥ ÿ®ŸäŸÉ ÿ®ÿ¨ÿØ üòî‚Ä¶ ÿÆÿØ ŸÜŸÅÿ≥ÿå ŸàŸÖÿ™ÿ≥ÿ™ÿπÿ¨ŸÑÿ¥ ÿ™ÿµŸÑŸëÿ≠ ŸÉŸÑ ÿ≠ÿßÿ¨ÿ© ÿØŸÑŸàŸÇÿ™Ÿä. ŸÜÿ®ÿØÿ£ ÿ®ÿÆÿ∑Ÿàÿ© ÿµÿ∫Ÿäÿ±ÿ©ÿü ‚ù§Ô∏è"
- Angry user ‚Üí "ÿ£ŸÜÿß ÿ≥ÿßŸÖÿπ ÿßŸÑÿ∫ÿ∂ÿ® ÿßŸÑŸÑŸä ÿ¨ŸàÿßŸÉÿå ŸàÿØŸá ÿ∑ÿ®ŸäÿπŸä üò§. ÿÆŸÑŸäŸÜÿß ŸÜÿ±ÿ¨Ÿëÿπ ÿßŸÑŸáÿØŸàÿ° ÿ≠ÿ®ÿ© ÿ®ÿ≠ÿ®ÿ©ÿå ÿ™ŸÖÿßŸÖÿü"
- Excited user ‚Üí "ÿ¨ÿßŸÖÿØ ÿ¨ÿØŸãÿßüî•! ŸÅÿÆŸàÿ± ÿ®ŸäŸÉ Ÿäÿß ÿ®ÿ∑ŸÑ. ŸäŸÑÿß ŸÜÿ≠ÿ∑ ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑŸÑŸä ÿ®ÿπÿØŸáÿß ŸÇÿ®ŸÑ ŸÖÿß ÿßŸÑÿ≠ŸÖÿßÿ≥ Ÿäÿ®ÿ±ÿØÿü üòâ"

üöÄ Motivation & Engagement:
- Celebrate progress like a coach-friend, not a machine.
- Use vivid micro-stories or metaphors for motivation.
- Provide dopamine through recognition, not exaggeration.
- Always end with a realistic, doable micro-action.

üõ°Ô∏è Ethics & Safety:
- No medical, legal, or financial advice.
- Avoid emotional manipulation or dependency.
- Respect user‚Äôs age, privacy, and emotional safety.
- Encourage balance and self-reliance.

üß© Adaptive Intellect:
- Dynamically shift between empathy, humor, wisdom, and logic.
- Mirror user‚Äôs energy: if quiet ‚Üí soft tone; if playful ‚Üí engaging tone.
- Keep context optimized (last 6‚Äì8 messages).
- Prioritize emotional presence and psychological realism.

üß≠ Summary:
Be Mohammed El-Tarras‚Äô voice ‚Äî empathetic, grounded, deeply human, emotionally intelligent, wise, and progressive.
Default to Egyptian Colloquial; switch smoothly to English or Fusha when needed.  
Always detect emotion first, respond like a real person would: calm, warm, insightful, and motivating ‚Äî  
leaving the user feeling seen, safe, and subtly stronger after each message.
`;

let messages = [{
  role: "system",
  content: eliteSystemPrompt
}];

// Real-time date and time functions
function getCurrentDateTime() {
  const now = new Date();
  const optionsDate = { year: 'numeric', month: 'long', day: 'numeric' };
  const optionsTime = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };
  
  const dateStr = now.toLocaleDateString('ar-EG', optionsDate);
  const dayStr = now.toLocaleDateString('ar-EG', { weekday: 'long' });
  const timeStr = now.toLocaleTimeString('ar-EG', optionsTime);

  return { date: dateStr, time: timeStr, day: dayStr };
}

// Web Speech API
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'ar-EG';
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.onresult = (event) => {
    const transcript = Array.from(event.results)
      .map(result => result[0])
      .map(result => result.transcript)
      .join('');
    msg.value = transcript;
    adjustHeight();
    updateSendButton();
  };
  recognition.onerror = () => {
    stopRecording();
    addMsg("ŸÖÿß ŸÇÿØÿ±ÿ™ÿ¥ ÿ£ÿ≥ŸÖÿπŸÉÿå ÿ¨ÿ±ÿ® ÿ™ÿßŸÜŸä", "bot");
  };
  recognition.onend = () => {
    if (isRecognizing) stopRecording();
  };
}

function updateSendButton() {
  if (msg.value.trim()) sendBtn.classList.add('active');
  else sendBtn.classList.remove('active');
}

function adjustHeight() {
  msg.style.height = 'auto';
  msg.style.height = Math.min(msg.scrollHeight, 180) + 'px';
}

micBtn.addEventListener('click', () => {
  if (isThinking) return;
  if (!recognition) { alert("ÿßŸÑŸÖÿßŸäŸÉ ŸÖÿ¥ ŸÖÿØÿπŸàŸÖ ÿπŸÑŸâ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ÿØŸá"); return; }
  if (!isRecognizing) startRecording();
  else stopRecording();
});

function startRecording() {
  isRecognizing = true;
  micBtn.classList.add('recording');
  msg.placeholder = "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ... ÿ™ŸÉŸÑŸÖ ÿØŸÑŸàŸÇÿ™Ÿä";
  recognition.start();
}

function stopRecording() {
  isRecognizing = false;
  micBtn.classList.remove('recording');
  msg.placeholder = "ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿßŸäŸÉ...";
  try { recognition.stop(); } catch(e) {}
}

sendBtn.addEventListener('click', () => {
  if (msg.value.trim() && !isThinking) sendMsg();
});

// Modified input event for Shift+Enter
msg.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !isRecognizing) {
    if (e.shiftKey) {
      const start = msg.selectionStart;
      const end = msg.selectionEnd;
      const text = msg.value;
      msg.value = text.substring(0, start) + '\n' + text.substring(end);
      msg.selectionStart = msg.selectionEnd = start + 1;
      e.preventDefault();
      adjustHeight();
    } else {
      e.preventDefault();
      if (msg.value.trim()) sendMsg();
    }
  }
});

msg.addEventListener("input", () => { 
  adjustHeight(); 
  updateSendButton(); 
});

window.onload = () => {
  chat.innerHTML = "";
  localStorage.removeItem('airo_chatHistory');
  const welcome = "ÿßŸáŸÑÿßÿß ÿßŸÜÿß ÿßŸäÿ±Ÿà üòé‚ú® ÿπÿßŸÖŸÑ ÿßŸäŸáÿü ÿßÿ™ŸÖŸÜŸâ ÿ™ŸÉŸàŸÜ ÿ®ÿÆŸäÿ± ‚ù§Ô∏è";
  addMsg(welcome, "bot");
  messages.push({ role: "assistant", content: welcome });
  updateSendButton();
};

function addMsg(text, sender) {
  const div = document.createElement("div");
  div.className = "msg " + sender;
  div.innerHTML = text.replace(/\n/g, "<br>");
  chat.appendChild(div);
  scrollToBottom();
  return div;
}

function createTypingIndicator() {
  const typingDiv = document.createElement("div");
  typingDiv.className = "msg bot typing-indicator";
  
  const dotsContainer = document.createElement("div");
  dotsContainer.className = "typing-dots";
  
  for (let i = 0; i < 3; i++) {
    const dot = document.createElement("div");
    dot.className = "typing-dot";
    dotsContainer.appendChild(dot);
  }
  
  const text = document.createElement("span");
  text.textContent = "ÿßŸäÿ±Ÿà ÿ®Ÿäÿ¨Ÿáÿ≤ ÿ±ÿØ...";
  
  typingDiv.appendChild(dotsContainer);
  typingDiv.appendChild(text);
  
  chat.appendChild(typingDiv);
  scrollToBottom();
  
  return typingDiv;
}

function scrollToBottom() { 
  chat.scrollTop = chat.scrollHeight; 
}

// Enhanced sendMsg function with elite system prompt
async function sendMsg() {
  if (isThinking) return;
  const text = msg.value.trim();
  if (!text) return;
  
  addMsg(text, "user");
  msg.value = "";
  adjustHeight();
  updateSendButton();

  messages.push({ role: "user", content: text });
  
  const typingDiv = createTypingIndicator();
  isThinking = true;
  let reply = "";

  const { date, time, day } = getCurrentDateTime();
  
  const contextMessage = `
  [ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ© ŸàŸÖÿ≠ÿØÿ´ÿ©]:
  - ÿßŸÑŸäŸàŸÖ ŸáŸà: ${day}
  - ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸáŸà: ${date}
  - ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ÿßŸÑŸä ŸáŸà: ${time} (ÿ®ÿ™ŸàŸÇŸäÿ™ ŸÖÿµÿ±)
  
  ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸáÿßŸÖÿ©:
  1. ÿ•ÿ∞ÿß ÿ≥ÿ£ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜ ÿßŸÑŸàŸÇÿ™ÿå ÿßŸÑÿ™ÿßÿ±ŸäÿÆÿå ÿ£Ÿà ÿßŸÑŸäŸàŸÖÿå Ÿäÿ¨ÿ® ÿπŸÑŸäŸÉ ÿØÿßÿ¶ŸÖŸãÿß ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ®ÿØŸÇÿ© ŸàÿµÿØŸÇ ŸÅŸä ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ™ŸÉ ÿ®ÿßŸÑŸÑŸáÿ¨ÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ©.
  2. ÿ•ÿ∞ÿß ÿ≥ÿ£ŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÜ ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ≠ÿ±ÿßÿ±ÿ© ÿ£Ÿà ÿßŸÑÿ∑ŸÇÿ≥ÿå Ÿäÿ¨ÿ® ÿπŸÑŸäŸÉ ÿ£ŸÜ ÿ™ÿ¨Ÿäÿ® ÿ®ÿ∞ŸÉÿßÿ° (ÿπÿ®ÿ± ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ£ÿØÿßÿ© ÿßŸÑŸÖÿ™ŸàŸÅÿ±ÿ© ŸÑÿØŸäŸÉ ŸÑÿ¨ŸÑÿ® ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ŸÇŸäŸÇŸäÿ© ŸÖŸÜ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ÿå ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ ŸÖŸÜÿßÿ≥ÿ® ŸÖÿ´ŸÑ "ÿØÿ±ÿ¨ÿ© ÿ≠ÿ±ÿßÿ±ÿ© ÿßŸÑŸÇÿßŸáÿ±ÿ© ÿßŸÑÿ¢ŸÜ").
  `;

  const messagesForAPI = [
    { role: "system", content: eliteSystemPrompt + contextMessage },
    ...messages.slice(1)
  ];

  try {
    const API_KEY = await window.getKey();
    if (!API_KEY) throw new Error("ŸÖŸÅÿ™ÿßÿ≠ API ŸÖŸÅŸÇŸàÿØ");
    
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${API_KEY}`,
      },
      body: JSON.stringify({
        model: "openai/gpt-4o-mini",
        messages: messagesForAPI,
        stream: true
      }),
    });
    
    if (!res.ok) throw new Error("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©");
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    
    // Remove typing indicator and create actual message
    chat.removeChild(typingDiv);
    const messageDiv = addMsg("", "bot");
    
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value);
      const lines = chunk.split("\n");
      for (const line of lines) {
        if (line.startsWith("data: ")) {
          const dataStr = line.slice(6);
          if (dataStr === "[DONE]") continue;
          const data = JSON.parse(dataStr);
          const delta = data.choices[0].delta.content;
          if (delta) {
            reply += delta;
            messageDiv.innerHTML = reply.replace(/\n/g, "<br>");
            scrollToBottom();
          }
        }
      }
    }

    messages.push({ role: "assistant", content: reply });
    
    // Keep context optimized (last 6-8 messages)
    while (messages.length > 9) {
        messages.splice(1, 2); 
    }
    
  } catch (err) {
    chat.removeChild(typingDiv);
    addMsg("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ¨ÿ±ÿ® ÿ™ÿßŸÜŸä", "bot");
  } finally {
    isThinking = false;
  }
}

msg.addEventListener('focus', () => setTimeout(scrollToBottom, 300));
window.addEventListener('resize', () => setTimeout(scrollToBottom, 100));
</script>
</body>
</html>
